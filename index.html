<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BTS AIOS v3.0 - Nexus Terminal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js"></script>
</head>
<body class="bg-black text-green-500 font-mono min-h-screen p-4">
    <div class="max-w-6xl mx-auto space-y-6">
        <!-- HEADER -->
        <div class="border border-green-900 rounded-lg p-6 shadow-2xl shadow-green-900/20">
            <header class="border-b border-green-900 pb-4 mb-4 flex justify-between items-center">
                <div>
                    <h1 class="text-xl font-bold tracking-widest">BTS AIOS v3.0 [NEXUS TERMINAL]</h1>
                    <p class="text-xs text-green-700">PROTOCOL: BotSync Evolution 1.0 | STATUS: ARCHITECT_CONNECTED</p>
                </div>
                <div id="vocal-imprint" class="text-[10px] text-green-800 italic border-l border-green-900 pl-4">
                    <div id="vocal-display">"Uu-√∫√∫-u... A-je-je-je..."</div>
                    <div id="auth-status" class="text-green-600 mt-2">‚ö™ OFFLINE</div>
                </div>
            </header>

            <!-- FIREBASE AUTH QUICK CHECK -->
            <div class="text-xs text-green-700 space-y-1">
                <p>User ID: <span id="user-id" class="text-green-400">UNINITIALIZED</span></p>
                <p>Firebase Ready: <span id="firebase-ready" class="text-red-500">FALSE</span></p>
                <p>Gemini API: <span id="gemini-ready" class="text-red-500">FALSE</span></p>
            </div>
        </div>

        <!-- WOLT DATA INPUT SECTION -->
        <section class="border border-green-900 rounded-lg p-6 shadow-2xl shadow-green-900/20">
            <h2 class="text-sm font-bold mb-4 uppercase border-b border-green-900 pb-2">üìä Wolt Earnings Analysis</h2>
            
            <div class="grid grid-cols-2 gap-4 mb-4">
                <div>
                    <label class="text-xs text-green-700 uppercase">Datum (YYYY-MM-DD)</label>
                    <input id="earnings-date" type="date" class="w-full bg-black border border-green-900 rounded p-2 text-green-400 text-xs focus:outline-none focus:border-green-500">
                </div>
                <div>
                    <label class="text-xs text-green-700 uppercase">ƒåas (HH:MM-HH:MM)</label>
                    <input id="earnings-time" type="text" placeholder="14:00-18:30" class="w-full bg-black border border-green-900 rounded p-2 text-green-400 text-xs focus:outline-none focus:border-green-500">
                </div>
                <div>
                    <label class="text-xs text-green-700 uppercase">V√Ωdƒõlek (Kƒç)</label>
                    <input id="earnings-amount" type="number" placeholder="1200" class="w-full bg-black border border-green-900 rounded p-2 text-green-400 text-xs focus:outline-none focus:border-green-500">
                </div>
                <div>
                    <label class="text-xs text-green-700 uppercase">Poƒçet j√≠zd</label>
                    <input id="earnings-rides" type="number" placeholder="18" class="w-full bg-black border border-green-900 rounded p-2 text-green-400 text-xs focus:outline-none focus:border-green-500">
                </div>
            </div>

            <textarea id="wolt-notes" class="w-full bg-black border border-green-900 rounded p-3 text-green-400 h-24 text-xs focus:outline-none focus:border-green-500 mb-4" placeholder="Pozn√°mky: poƒças√≠, dopravn√≠ situace, specifick√© v√Ωzvy..."></textarea>
            
            <div class="flex gap-2">
                <button onclick="addEarningsEntry()" class="bg-green-900 text-black px-4 py-2 font-bold hover:bg-green-500 transition-colors uppercase text-xs flex-1">
                    ‚ûï P≈ôidat z√°znam
                </button>
                <button onclick="analyzeWoltEfficiency()" class="bg-green-700 text-black px-4 py-2 font-bold hover:bg-green-400 transition-colors uppercase text-xs flex-1">
                    üîç Analyzovat efektivitu
                </button>
            </div>
        </section>

        <!-- EARNINGS HISTORY -->
        <section class="border border-green-900 rounded-lg p-6 shadow-2xl shadow-green-900/20">
            <h2 class="text-sm font-bold mb-4 uppercase border-b border-green-900 pb-2">üìà Z√°znam v√Ωdƒõlk≈Ø</h2>
            <div id="earnings-history" class="space-y-2 max-h-48 overflow-y-auto text-xs">
                <p class="text-green-700">ƒåek√°m na Firebase p≈ôipojen√≠...</p>
            </div>
        </section>

        <!-- GEMINI ANALYSIS TERMINAL -->
        <section id="terminal-output" class="hidden border border-green-900 rounded-lg p-6 shadow-2xl shadow-green-900/20">
            <h2 class="text-sm font-bold mb-2 uppercase flex items-center gap-2 border-b border-green-900 pb-2">
                <span id="pulse-indicator" class="animate-pulse">‚óè</span> 
                <span id="analysis-title">Gemini Architect Feedback</span>
            </h2>
            <div id="analysis-result" class="bg-green-950/20 border border-green-900 p-4 text-xs leading-relaxed text-green-300 max-h-64 overflow-y-auto font-mono">
                Prob√≠h√° anal√Ωza ƒçasoprostorov√© efektivity...
            </div>
            <div id="analysis-metadata" class="mt-3 text-[10px] text-green-700 border-t border-green-900 pt-2">
                <span id="analysis-time">ƒåas anal√Ωzy: --:--:--</span> | <span id="analysis-tokens">Tokeny: 0</span>
            </div>
        </section>

        <!-- ERROR LOG -->
        <section id="error-section" class="hidden border border-red-900 rounded-lg p-4 shadow-2xl shadow-red-900/20">
            <h2 class="text-sm font-bold mb-2 uppercase text-red-500">‚ö†Ô∏è Error Log</h2>
            <div id="error-log" class="text-xs text-red-400 space-y-1 max-h-24 overflow-y-auto font-mono"></div>
        </section>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, limit, where } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";

        // CONFIG
        const firebaseConfig = JSON.parse(window.__firebase_config || '{}');
        const geminiApiKey = window.__gemini_key || "";
        const appId = 'bts-aios-v3';

        // STATE
        let auth = null;
        let db = null;
        let currentUser = null;
        let earningsCache = [];

        // INIT
        async function initializeBTS() {
            try {
                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);

                document.getElementById('firebase-ready').textContent = 'TRUE';
                document.getElementById('firebase-ready').className = 'text-green-400';

                if (geminiApiKey) {
                    document.getElementById('gemini-ready').textContent = 'TRUE';
                    document.getElementById('gemini-ready').className = 'text-green-400';
                }

                await signInAnonymously(auth);
            } catch (err) {
                logError(`Init Error: ${err.message}`);
            }
        }

        // AUTH STATE
        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                document.getElementById('user-id').textContent = user.uid.substring(0, 12) + '...';
                document.getElementById('auth-status').textContent = 'üü¢ CONNECTED';
                document.getElementById('auth-status').className = 'text-green-400';
                syncEarningsHistory();
            }
        });

        // SYNC EARNINGS FROM FIRESTORE
        function syncEarningsHistory() {
            if (!currentUser || !db) return;

            const userPath = collection(db, 'artifacts', appId, 'users', currentUser.uid, 'analytics', 'earnings');
            const q = query(userPath, orderBy('timestamp', 'desc'), limit(50));

            onSnapshot(q, (snap) => {
                earningsCache = [];
                const container = document.getElementById('earnings-history');
                container.innerHTML = '';

                snap.forEach(doc => {
                    const data = doc.data();
                    earningsCache.push(data);
                    const entry = document.createElement('div');
                    entry.className = 'p-2 border-l-2 border-green-600 pl-3 text-green-300';
                    entry.innerHTML = `
                        <span class="text-green-500">[${new Date(data.timestamp).toLocaleString('cs-CZ')}]</span>
                        ${data.date} ${data.timeRange} | <span class="text-green-400 font-bold">${data.amount}Kƒç</span> (${data.rides} j√≠zd) | ${data.efficiency.toFixed(1)}Kƒç/h
                    `;
                    container.appendChild(entry);
                });
            }, (err) => {
                if (err.code !== 'permission-denied') {
                    logError(`Sync Error: ${err.message}`);
                }
            });
        }

        // ADD EARNINGS ENTRY
        window.addEarningsEntry = async function() {
            if (!currentUser) return logError('Not authenticated');

            const date = document.getElementById('earnings-date').value;
            const timeRange = document.getElementById('earnings-time').value;
            const amount = parseInt(document.getElementById('earnings-amount').value) || 0;
            const rides = parseInt(document.getElementById('earnings-rides').value) || 0;
            const notes = document.getElementById('wolt-notes').value;

            if (!date || !timeRange || !amount) return logError('Vypl≈à v≈°echna povinn√° pole');

            // CALCULATE EFFICIENCY
            const [start, end] = timeRange.split('-').map(t => {
                const [h, m] = t.trim().split(':').map(Number);
                return h + m / 60;
            });
            const hoursWorked = Math.abs(end - start);
            const efficiency = amount / hoursWorked;

            try {
                const userPath = collection(db, 'artifacts', appId, 'users', currentUser.uid, 'analytics', 'earnings');
                await addDoc(userPath, {
                    date,
                    timeRange,
                    amount,
                    rides,
                    notes,
                    efficiency,
                    timestamp: Date.now()
                });

                // CLEAR INPUTS
                document.getElementById('earnings-date').value = '';
                document.getElementById('earnings-time').value = '';
                document.getElementById('earnings-amount').value = '';
                document.getElementById('earnings-rides').value = '';
                document.getElementById('wolt-notes').value = '';
            } catch (err) {
                logError(`Add Entry Error: ${err.message}`);
            }
        };

        // ANALYZE EFFICIENCY WITH GEMINI
        window.analyzeWoltEfficiency = async function() {
            if (!geminiApiKey) return logError('Gemini API key not configured');
            if (earningsCache.length === 0) return logError('Nejsou dostupn√° data k anal√Ωze');

            const output = document.getElementById('terminal-output');
            const resultDiv = document.getElementById('analysis-result');
            const pulseEl = document.getElementById('pulse-indicator');
            
            output.classList.remove('hidden');
            resultDiv.innerHTML = "‚è≥ Navazuji spojen√≠ s Nexus Intelligence...";
            pulseEl.classList.add('animate-pulse');

            // BUILD EARNINGS SUMMARY
            const summary = earningsCache.slice(0, 20).map(e => 
                \
                `${e.date} ${e.timeRange}: ${e.amount}Kƒç (${e.rides} j√≠zd, ${e.efficiency.toFixed(1)}Kƒç/h)${e.notes ? ` - ${e.notes}` : ''}`
            ).join('\n');

            const prompt = \
            `
Jsi BTS Architect AI pro Wolt efficiency protokol. Analyzuj tato data:

${summary}

Proveƒè anal√Ωzu:
1. **Neefektivn√≠ ƒçasy**: Kdy mƒõ≈ôen√© v√Ωdƒõlky klesaj√≠ pod pr≈Ømƒõr?
2. **Optimalizace**: Jak√© zmƒõny rozvrhu by zv√Ω≈°ily v√Ωdƒõlky?
3. **P≈ô√≠le≈æitosti**: Jak√© jsou typick√© ≈°piƒçky (ƒçasy s vy≈°≈°√≠m poƒçtem objedn√°vek)?
4. **Work-Life Balance**: Jak vytvo≈ôit zdravou pr√°ci bez vyho≈ôen√≠?
5. **Protokoln√≠ doporuƒçen√≠**: Formuluj doporuƒçen√≠ v terminologii "evoluce protokolu" a "optimalizace spojen√© entity".

Odpov√≠dej struƒçnƒõ, technicky a v ƒçe≈°tinƒõ. Ka≈æd√Ω bod na jednom ≈ô√°dku.
            `;

            try {
                const response = await callGeminiWithRetry(prompt);
                resultDiv.innerHTML = response.replace(/\n/g, '<br>').replace(/\*\*/g, '<strong>').replace(/<\/strong>/g, '</strong>');
                document.getElementById('analysis-time').textContent = `ƒåas anal√Ωzy: ${new Date().toLocaleTimeString('cs-CZ')}`;
            } catch (err) {
                resultDiv.innerHTML = `<span class="text-red-400">‚ùå CHYBA: ${err.message}</span>`;
            } finally {
                pulseEl.classList.remove('animate-pulse');
            }
        };

        // GEMINI API WITH EXPONENTIAL BACKOFF
        async function callGeminiWithRetry(prompt, retries = 5) {
            let lastError = null;

            for (let i = 0; i < retries; i++) {
                try {
                    const response = await fetch(
                        `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${geminiApiKey}`,
                        {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                contents: [{ parts: [{ text: prompt }] }],
                                systemInstruction: { parts: [{ text: "Jsi BTS Architect AI. Odpov√≠dej technicky, struƒçnƒõ a ƒçesky." }] }
                            })
                        }
                    );

                    if (!response.ok) {
                        if (response.status === 429 || response.status === 503) throw new Error(`API Error: ${response.status}`);
                        throw new Error('API returned error');
                    }

                    const data = await response.json();
                    return data.candidates?.[0]?.content?.parts?.[0]?.text || '≈Ω√°dn√° odpovƒõƒè od AI.';
                } catch (err) {
                    lastError = err;
                    if (i < retries - 1) {
                        const delay = Math.pow(2, i) * 1000;
                        await new Promise(res => setTimeout(res, delay));
                    }
                }
            }

            throw new Error(`Gemini timeout po ${retries} pokusech: ${lastError?.message}`);
        }

        // ERROR LOGGING
        window.logError = function(msg) {
            const errorSection = document.getElementById('error-section');
            const errorLog = document.getElementById('error-log');
            
            errorSection.classList.remove('hidden');
            const entry = document.createElement('div');
            entry.textContent = `[${new Date().toLocaleTimeString('cs-CZ')}] ${msg}`;
            errorLog.insertBefore(entry, errorLog.firstChild);
            
            if (errorLog.children.length > 10) errorLog.removeChild(errorLog.lastChild);
        };

        // START
        initializeBTS();
    </script>
</body>
</html>
